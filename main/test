    spi_bus_config_t bus_config = {
        .mosi_io_num = 13,
        .miso_io_num = 12,
        .sclk_io_num = 14,
        .quadwp_io_num = -1,
        .quadhd_io_num = -1,
        .max_transfer_sz = 32,
    };
    esp_err_t ret = spi_bus_initialize(SPI2_HOST, &bus_config, SPI_DMA_CH_AUTO);
    ESP_ERROR_CHECK(ret);
    spi_device_interface_config_t dev_config = {
        .address_bits = 8,
        .command_bits = 0,
        .dummy_bits = 0,
        .cs_ena_pretrans = 8,
        .clock_speed_hz = 2500000,
        .mode = 1,
        .spics_io_num = 15,
        .queue_size = 1,
        .flags = SPI_DEVICE_HALFDUPLEX | SPI_DEVICE_NO_DUMMY
        //.flags = SPI_DEVICE_NO_DUMMY
    };
    spi_device_handle_t handle;
    ret = spi_bus_add_device(SPI2_HOST, &dev_config, &handle);
    ESP_ERROR_CHECK(ret);
    uint8_t buf[8];
    spi_transaction_t read_all = {
        .addr = 0x00,
        .length = 24,
        .rxlength = 24,
        .tx_buffer = NULL,
        //.tx_buffer = &regaddrs,
        .flags = SPI_TRANS_USE_RXDATA,
        .rx_buffer = NULL
    };
    ret = spi_device_polling_transmit(handle, &read_all);
    ESP_LOGI("read_all", "%04d", ret);
    //hexdump(buf, 8);
    printf("%08lX\n",*((uint32_t*)read_all.rx_data));
    //uint8_t regval = 0b11010001;
    //buf[0] = 0b11010001;
    spi_transaction_t confreg = {
        .addr = 0x80,
        .length = 8,
        .rxlength = 0,
        .tx_buffer = NULL,
        .rx_buffer = NULL,
        .flags = SPI_TRANS_USE_TXDATA,
        .tx_data[0] = 0b10000000
    };

                xdump(payload->data, 8+sizeof(spibus_cmdaddr_t));
            xdump(&(payload->data[sizeof(spibus_cmdaddr_t)]), 8+(payload->inDataLen));
            printf("[spi] tx_target: %p, spibus_execute.tx_data: %p, spibus_execute.tx_buffer: %p\n", 
                    tx_target, spibus_execute.tx_data, spibus_execute.tx_buffer);
            xdump(tx_target,4);


cbus_driver_t *cbus = (cbus_driver_t *)i2cbus_get_bus();
    cbus_device_config_t dev_conf = (cbus_device_config_t) {
        .bus_type = CBUS_BUS_I2C,
        .i2c_device = { 
            .scl_gpio = GPIO_NUM_26,
            .sda_gpio = GPIO_NUM_18,
            .dev_addr_length = I2C_ADDR_BIT_LEN_7,
            .scl_speed_hz = 400000U,
            .xfer_timeout_ms = 10,
            .device_address = 0x76,
            .disable_ack_check = false
        }
    };

    uint8_t scanbuf[128];
    cbus_driver_t *spidrv = (cbus_driver_t *)spi_get_bus();
    cbus_common_id_t spidev = spidrv->deattach(0x11E3868CUL);
    ESP_LOGW("spidrv", "ID:%08lX [%04X]\n", spidev.id, spidev.error);
    cbus_device_config_t spi_dev_conf = {
        .bus_type = CBUS_BUS_SPI,
        .spi_device = {
            .mosi_gpio = GPIO_NUM_13,
            .miso_gpio = GPIO_NUM_12,
            .sclk_gpio = GPIO_NUM_14,
            .cs_gpio = GPIO_NUM_15,
            .addr_bits = 8,
            .cmd_bits = 0,
            .dummy_bits = 0,
            .mode = 1,
            .pretrans = 8,
            .clock_speed = 2500000,
            .flags = SPI_DEVICE_HALFDUPLEX | SPI_DEVICE_NO_DUMMY
        }
    };

    spidev = spidrv->attach(&spi_dev_conf);
    //ESP_LOGW("spidrv", "ID:%08lX [%04X]\n", spidev.id, spidev.error);
    spidev = spidrv->desc(spidev.id, scanbuf, 35);
    printf("desc: %s\n", scanbuf);
    cbus_common_cmd_t spi_read_all = {
        .command = CBUSCMD_READ,
        .device_id = spidev.id,
        .inDataLen = 0,
        .outDataLen = 8,
        .data = scanbuf
    };
    ((spibus_cmdaddr_t *)(spi_read_all.data))->address = 0x00;

    spidev = spidrv->execute(&spi_read_all);
    //ESP_LOGW("spidrv", "ID:%08lX [%04X]\n", spidev.id, spidev.error);
    //hexdump(scanbuf, 16);

    cbus_common_cmd_t spi_write_conf = {
        .command = CBUSCMD_WRITE,
        .device_id = spidev.id,
        .inDataLen = 1,
        .outDataLen = 0,
        .data = scanbuf
    };
    scanbuf[sizeof(spibus_cmdaddr_t)] = 0b10110001;
    ((spibus_cmdaddr_t *)(spi_write_conf.data))->address = 0x80;
    ((spibus_cmdaddr_t *)(spi_write_conf.data))->command = 0x4554;
    spidev = spidrv->execute(&spi_write_conf);
    ESP_LOGW("spidrv", "ID:%08lX [%04X]\n", spidev.id, spidev.error);
    vTaskDelay(100);
    //scanbuf[sizeof(spibus_cmdaddr_t)] = 0b10110001;
    //spidev = spidrv->execute(&spi_write_conf);
    //ESP_LOGW("spidrv", "ID:%08lX [%04X]\n", spidev.id, spidev.error);
    //vTaskDelay(100);
    ((spibus_cmdaddr_t *)(spi_read_all.data))->address = 0x00;
    spidev = spidrv->execute(&spi_read_all);
    //ESP_LOGW("spidrv", "ID:%08lX [%04X]\n", spidev.id, spidev.error);
    hexdump(scanbuf, 16);
    return;
    //Blocked
    cbus_common_id_t desc = cbus->attach(&dev_conf);

    //uint8_t scanbuf[128];
    cbus->desc(desc.id, scanbuf, 35);
    printf("%s\n", scanbuf);

    cbus_driver_t *owbus = (cbus_driver_t *)ow_get_bus();
    cbus_device_config_t ow_device_config = {
        .bus_type = CBUS_BUS_1WIRE,
        .ow_device = {
            .data_gpio = GPIO_NUM_32,
            .rom_code = 0x28FF8CA7741604DBLLU,
            //.rom_code = {
                //.raw_address = {0xDB, 0x04, 0x16, 0x74, 0xA7, 0x8C, 0xFF, 0x28}
                //.raw_address = {0x28, 0xFF, 0x8C, 0xA7, 0x74, 0x16, 0x04, 0xDB}
            //},
            .reserved = 0
        }
    };

    //uint8_t scanbuf[128];

    cbus_common_cmd_t scancmd = (cbus_common_cmd_t) {
        .command = CBUSCMD_SCAN,
        .device_id = 0,
        .inDataLen = 0,
        .outDataLen = 0,
        .data = scanbuf
    };
    
    *((gpio_num_t *)scanbuf) = GPIO_NUM_32;
    cbus_common_id_t codes = owbus->execute(&scancmd);
    //hexdump(scancmd.data, 8);
    printf("Return code 0x%02X - Device(s): %lu %016llX\n", codes.error, codes.id, *((uint64_t *)scancmd.data));

    //*((uint64_t *)ow_device_config.ow_device.rom_code.raw_address) = *((uint64_t *)scancmd.data);
    
    cbus_common_id_t retcode = owbus->attach(&ow_device_config);
    owbus->desc(retcode.id, scanbuf, 35);
    printf("\n%s\n", scanbuf);

    ow_device_config.ow_device.data_gpio = GPIO_NUM_33;
    owbus->attach(&ow_device_config);

    ow_device_config.ow_device.data_gpio = GPIO_NUM_22;
    owbus->attach(&ow_device_config);
    //printf("cbus_common_id_t %02X / %08lX\n", retcode.error, retcode.id);
    /*
    ow_device_config.ow_device.data_gpio = GPIO_NUM_18;
    retcode = owbus->attach(&ow_device_config);
    uint32_t deattach = retcode.id;
    printf("cbus_common_id_t %02X / %08lX\n", retcode.error, retcode.id);

    ow_device_config.ow_device.data_gpio = GPIO_NUM_26;
    retcode = owbus->attach(&ow_device_config);
    printf("cbus_common_id_t %02X / %08lX\n", retcode.error, retcode.id);
    owbus_dump_devices();
    retcode = owbus->deattach(deattach);
    owbus_dump_devices();
    ow_device_config.ow_device.data_gpio = GPIO_NUM_21;
    retcode = owbus->attach(&ow_device_config);
    printf("cbus_common_id_t %02X / %08lX\n", retcode.error, retcode.id);
    owbus_dump_devices();
    ow_device_config.ow_device.data_gpio = GPIO_NUM_21;
    retcode = owbus->attach(&ow_device_config);
    printf("cbus_common_id_t %02X / %08lX\n", retcode.error, retcode.id);

    ow_device_config.ow_device.rom_code.serial_number[6] = 0x55;
    retcode = owbus->attach(&ow_device_config);
    printf("cbus_common_id_t %02X / %08lX\n", retcode.error, retcode.id); */

    //owbus_dump_devices();

    uint8_t buf[128];

    cbus_common_cmd_t cmd = (cbus_common_cmd_t) {
        .command = CBUSCMD_RESET,
        .device_id = retcode.id,
        .inDataLen = 4,
        .outDataLen = 9,    //Scratchpad
        .data = buf
    };
    owbus->execute(&cmd);
    cmd.data[0] = 0x4E;
    cmd.data[1] = 0x53;
    cmd.data[2] = 0x21;
    cmd.data[3] = 0x5F;
    cmd.command = CBUSCMD_WRITE;
    owbus->execute(&cmd);

    cmd.command = CBUSCMD_RESET;
    owbus->execute(&cmd);

    cmd.data[0] = 0x44;
    cmd.inDataLen = 1;
    cmd.command = CBUSCMD_WRITE;
    owbus->execute(&cmd);

    vTaskDelay(pdMS_TO_TICKS(800));

    cmd.command = CBUSCMD_RESET;
    owbus->execute(&cmd);

    cmd.command = CBUSCMD_READ;
    cmd.data[0] = 0xBE;
    cmd.inDataLen = 1;
    owbus->execute(&cmd);

    hexdump(cmd.data, 9);
    printf("0x%02X, 0x%02X\n", onewire_crc8(0, cmd.data, 8), onewire_crc8(0, cmd.data, 9));

    cmd.command = CBUSCMD_SCAN;
    retcode = owbus->execute(&cmd);
    printf("Return code 0x%02X - Device(s): %lu %016llX\n", retcode.error, retcode.id, *((uint64_t *)cmd.data));

    //**/owbus->getaddress(&cmd);
    //**/uint64_t rom = *((uint64_t *)cmd.data);
    //**/cmd.data[0] = ONEWIRE_CMD_MATCH_ROM;
    ///**/cmd.data[9] = 0x4E;
    //**/*((uint64_t *)(&cmd.data[1])) = rom;
    /*owbus->execute(&cmd);

    cmd.data[10] = 0x52;
    cmd.data[11] = 0x35;
    cmd.data[12] = 0x3F;
    cmd.inDataLen = 13;

    cmd.command = CBUSCMD_WRITE;
    hexdump(cmd.data, 10);
    owbus->execute(&cmd);

    cmd.data[9] = 0xBE;
    cmd.inDataLen = 10;
    cmd.command = CBUSCMD_RESET;
    owbus->execute(&cmd);
    //hexdump(cmd.data, cmd.inDataLen);
    cmd.command = CBUSCMD_WRITE;
    owbus->execute(&cmd);

    cmd.command = CBUSCMD_READ;
    owbus->execute(&cmd);
    */

    //payload->data[9] = payload->data[0];
    //payload->data[0] = ONEWIRE_CMD_MATCH_ROM;
    //memcpy(&payload->data[1], &(device->address), 8);

    //#define DS18B20_CMD_CONVERT_TEMP      0x44
    //#define DS18B20_CMD_WRITE_SCRATCHPAD  0x4E
    //#define DS18B20_CMD_READ_SCRATCHPAD   0xBE
    //test_channles();

    /*uint32_t id_i2c0d0 = cbus->attach(&dev_conf).id;

    dev_conf.i2c_device.scl_gpio = GPIO_NUM_22;
    dev_conf.i2c_device.sda_gpio = GPIO_NUM_21;
    uint32_t id_i2c1d0 = cbus->attach(&dev_conf).id;
    
    i2cbus_dump_devices();
    uint8_t buf[127];

    cbus_common_cmd_t cmd = (cbus_common_cmd_t) {
        .command = CBUSCMD_RW,
        .device_id = id_i2c0d0,
        .inDataLen = 1,
        .outDataLen = 15,
        .data = buf
    };
    buf[0] = 0xE1;
    cbus->rw(&cmd);
    hexdump(buf, 15);
    cmd.device_id = id_i2c1d0;
    buf[0] = 0xE1;
    cbus->rw(&cmd);
    hexdump(buf, 15);

    cmd.outDataLen = 25;
    buf[0] = 0x88;
    cbus->rw(&cmd);
    hexdump(buf, 25);

    cmd.device_id = id_i2c0d0;
    buf[0] = 0x88;
    cbus->rw(&cmd);
    hexdump(buf, 25);
   
    i2cbus_dump_devices(); */
    //printf("%p, cbus_i2c->attach:%p cbus_i2c->deattach:%p [%04lx][%ld]\n", cbus, cbus->attach, cbus->deattach, cbus->attach(0), cbus->deattach(123));
    //uint64_t ROMCode = 0xDB041674A78CFF28LLU;
    //printf("swaped %016llX\n", swap_uint64(ROMCode));


    #define cbus_event_err(event_data, rcode) ( {((cbus_event_data_t *)event_data)->status = rcode; \
            esp_event_post_to(*(run_config->cbus_event_loop), CBUS_EVENT, CBUS_EVENT_ERROR, event_data, sizeof(cbus_event_data_t), 1);});

#define cbus_event_post(event_data) ( { \
            ((cbus_event_data_t *)event_data)->status = CBUS_OK; \
            esp_event_post_to(*(run_config->cbus_event_loop), CBUS_EVENT, CBUS_EVENT_DATA, event_data, sizeof(cbus_event_data_t), 1);})

#define cbus_result_post(exec_result) ({        \
    if(CBUS_OK == (exec_result).error) { cbus_event_post(event_data);} \
    else { cbus_event_err(event_data, exec_result.error);} })


/** Common bus event data structure */
typedef struct {
    struct {
        uint32_t command:4;     /*!< Command to execute */
        uint32_t data_type:3;   /*!< Data type */
        uint32_t inDataLen:7;   /*!< Data length send to device */
        uint32_t outDataLen:7;  /*!< Data length received from device */
        uint32_t status:4;      /*!< Bus status code */
        uint32_t reserved:7;    /*!< Not used */
    };
    uint32_t device_id;     /*!< Target device ID */
    uint32_t device_cmd;    /*!< Command send to device */    
    uint64_t reg_address;   /*!< Device register/memory address */
    uint32_t event_it;      /*!< User event ID */
    uint8_t payload[128];   /*!< Command payload */
} cbus_event_data_t;


/** Common bus command structure */
typedef struct {
    struct {
        uint32_t command:4;     /*!< Command code */
        uint32_t inDataLen:7;   /*!< Data length send to device */
        uint32_t outDataLen:7;  /*!< Data length received from device */
        uint32_t reserved:14;   /*!< Not used */
    };
    uint32_t device_id; /*!< Target device id */
    uint32_t device_cmd;    /*!< Command send to device */    
    uint64_t reg_address;   /*!< Device register/memory address */
    uint8_t *data;      /*!< Pointer to data buffer */
} cbus_common_cmd_t;



